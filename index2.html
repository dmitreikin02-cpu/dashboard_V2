<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–π –î–∞—à–±–æ—Ä–¥</title>
    
    <!-- CDN Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/plugin/customParseFormat.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            padding: 10px;
            min-height: 100vh;
            overflow-y: auto;
        }
        .container {
            max-width: 1920px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 15px 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            min-height: calc(100vh - 20px);
            display: flex;
            flex-direction: column;
        }
        .header {
            text-align: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .last-update {
            font-size: 0.95rem;
            color: #666;
            font-weight: 500;
        }
        .kpi-section {
            display: none;
        }
        .kpi-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
            transition: transform 0.2s ease;
        }
        .kpi-card:hover {
            transform: translateY(-3px);
        }
        .kpi-card h3 {
            font-size: 0.9rem;
            margin-bottom: 8px;
            opacity: 0.9;
            font-weight: 600;
        }
        .kpi-card .value {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 2px;
        }
        .kpi-card .unit {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        .charts-section {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 10px;
            flex: 1;
        }
        .chart-container {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }
        .chart-wrapper {
            position: relative;
            flex: 1;
            min-height: 0;
            margin-bottom: 10px;
        }
        .top-performers {
            background: white;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        .top-performers h4 {
            color: #667eea;
            margin-bottom: 6px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .top-performers ol {
            list-style-position: inside;
            padding-left: 0;
            margin: 0;
        }
        .top-performers li {
            padding: 4px 6px;
            margin-bottom: 3px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 0.75rem;
            border-left: 2px solid #667eea;
            line-height: 1.3;
        }
        .top-performers li:last-child {
            margin-bottom: 0;
        }
        .top-performers li:nth-child(1) {
            background: #ffd700;
            border-left-color: #ffa500;
            font-weight: bold;
        }
        .top-performers li:nth-child(2) {
            background: #e8e8e8;
            border-left-color: #c0c0c0;
        }
        .top-performers li:nth-child(3) {
            background: #f4e4c1;
            border-left-color: #cd7f32;
        }
        .norms-section {
            display: none;
        }
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.5rem;
            color: #667eea;
        }
        .error {
            background: #ff3b3b;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            font-size: 1.2rem;
        }
        @media (max-width: 1400px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
            
            .kpi-section {
                grid-template-columns: 1fr;
            }
        }
        @media (min-width: 1400px) and (max-width: 1920px) {
            .container {
                padding: 20px;
            }
            
            .chart-wrapper {
                height: 280px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="last-update" id="lastUpdate">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
        </div>
 
        <div id="errorContainer"></div>
        
        <div class="kpi-section" id="kpiSection">
            <div class="kpi-card">
                <h3>–ü—Ä–∏—ë–º–∫–∞</h3>
                <div class="value" id="kpiReceiving">-</div>
                <div class="unit">—à—Ç—É–∫</div>
            </div>
            <div class="kpi-card">
                <h3>–†–∞–∑–º–µ—â–µ–Ω–∏–µ</h3>
                <div class="value" id="kpiPlacement">-</div>
                <div class="unit">–∫–æ—Ä–æ–±–æ–≤</div>
            </div>
            <div class="kpi-card">
                <h3>–°–±–æ—Ä–∫–∞</h3>
                <div class="value" id="kpiPicking">-</div>
                <div class="unit">–∑–∞–¥–∞—á</div>
            </div>
        </div>
 
        <div class="charts-section">
            <div class="chart-container">
                <div class="chart-wrapper">
                    <canvas id="chartReceiving"></canvas>
                </div>
                <div class="top-performers" id="topReceiving"></div>
            </div>
 
            <div class="chart-container">
                <div class="chart-wrapper">
                    <canvas id="chartPlacement"></canvas>
                </div>
                <div class="top-performers" id="topPlacement"></div>
            </div>
 
            <div class="chart-container">
                <div class="chart-wrapper">
                    <canvas id="chartPicking"></canvas>
                </div>
                <div class="top-performers" id="topPicking"></div>
            </div>
        </div>
 
        <div class="norms-section">
            <h3>üìã –ù–æ—Ä–º–∞—Ç–∏–≤—ã (–≤ —Å—É—Ç–∫–∏)</h3>
            <div class="norms-grid">
                <div class="norm-item">
                    <div class="label">–ü—Ä–∏—ë–º–∫–∞</div>
                    <div class="value" id="normReceiving">-</div>
                    <div class="unit">—à—Ç—É–∫</div>
                </div>
                <div class="norm-item">
                    <div class="label">–†–∞–∑–º–µ—â–µ–Ω–∏–µ</div>
                    <div class="value" id="normPlacement">-</div>
                    <div class="unit">–∫–æ—Ä–æ–±–æ–≤</div>
                </div>
                <div class="norm-item">
                    <div class="label">–°–±–æ—Ä–∫–∞</div>
                    <div class="value" id="normPicking">-</div>
                    <div class="unit">–∑–∞–¥–∞—á</div>
                </div>
            </div>
        </div>
    </div>
 
    <script>
        // ============================================
        // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
        // ============================================
        const CONFIG = {
            DATA_PATH: 'data.xlsx',
            REFRESH_INTERVAL_MS: 60000, // 60 —Å–µ–∫—É–Ω–¥
            DATE_RANGE_DAYS: 30,        // 30 –¥–Ω–µ–π –¥–ª—è –±–æ–ª—å—à–µ–π –≥–∏–±–∫–æ—Å—Ç–∏
            TOP_N: 3,
            
            NORMS: {
                receiving: 120,    // —à—Ç
                placement: 250,    // –∫–æ—Ä–æ–±–∞
                picking: 300       // –∑–∞–¥–∞—á–∏
            },
            
            COLORS: {
                LOW: '#ff3b3b',      // –∫—Ä–∞—Å–Ω—ã–π (0-70% –Ω–æ—Ä–º—ã)
                MID: '#ffcc00',      // –∂—ë–ª—Ç—ã–π (70-100% –Ω–æ—Ä–º—ã)
                HIGH: '#00b050'      // –∑–µ–ª—ë–Ω—ã–π (100%+ –Ω–æ—Ä–º—ã)
            }
        };
        // ============================================
        // –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
        // ============================================
        let charts = {
            receiving: null,
            placement: null,
            picking: null
        };
        
        let lastFileModified = null; // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ñ–∞–π–ª–∞
        let autoRefreshTimer = null;
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è dayjs —Å –ø–ª–∞–≥–∏–Ω–æ–º –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞
        dayjs.extend(window.dayjs_plugin_customParseFormat);
        // ============================================
        // ETL: –ó–ê–ì–†–£–ó–ö–ê –ò –û–ë–†–ê–ë–û–¢–ö–ê –î–ê–ù–ù–´–•
        // ============================================
        
        /**
         * –ó–∞–≥—Ä—É–∂–∞–µ—Ç Excel —Ñ–∞–π–ª –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
         */
        async function loadExcelFile(filePath) {
            try {
                // –î–æ–±–∞–≤–ª—è–µ–º timestamp –¥–ª—è –æ–±—Ö–æ–¥–∞ –∫–µ—à–∞
                const cacheBuster = `?t=${new Date().getTime()}`;
                const response = await fetch(filePath + cacheBuster);
                
                if (!response.ok) {
                    throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª: ${response.statusText}`);
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞—Ç—É –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ñ–∞–π–ª–∞
                const lastModified = response.headers.get('Last-Modified');
                if (lastModified && lastFileModified && lastModified !== lastFileModified) {
                    console.log('üîÑ –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–∞, –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ...');
                }
                lastFileModified = lastModified;
                
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                
                return jsonData;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞:', error);
                throw error;
            }
        }
        
        /**
         * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞ –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –¥–∞—à–±–æ—Ä–¥ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
         */
        async function checkFileChanges() {
            try {
                const cacheBuster = `?t=${new Date().getTime()}`;
                const response = await fetch(CONFIG.DATA_PATH + cacheBuster, { method: 'HEAD' });
                
                if (response.ok) {
                    const currentModified = response.headers.get('Last-Modified');
                    
                    if (lastFileModified && currentModified && currentModified !== lastFileModified) {
                        console.log('üì• –§–∞–π–ª –∏–∑–º–µ–Ω–∏–ª—Å—è, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ...');
                        await updateDashboard();
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–∞–π–ª–∞:', error);
            }
        }
        /**
         * –ü–∞—Ä—Å–∏—Ç –¥–∞—Ç—É –∏–∑ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤
         */
        function parseDate(dateValue) {
            if (!dateValue) return null;
            
            // –ï—Å–ª–∏ —ç—Ç–æ —á–∏—Å–ª–æ (Excel serial date)
            if (typeof dateValue === 'number') {
                const excelEpoch = new Date(1899, 11, 30);
                const date = new Date(excelEpoch.getTime() + dateValue * 86400000);
                return dayjs(date);
            }
            
            // –ï—Å–ª–∏ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞
            if (typeof dateValue === 'string') {
                // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã
                const formats = ['DD.MM.YYYY', 'YYYY-MM-DD', 'DD/MM/YYYY', 'MM/DD/YYYY'];
                for (const format of formats) {
                    const parsed = dayjs(dateValue, format, true);
                    if (parsed.isValid()) return parsed;
                }
                
                // –ü—Ä–æ–±—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥
                const parsed = dayjs(dateValue);
                if (parsed.isValid()) return parsed;
            }
            
            return null;
        }
        /**
         * –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —á–∏—Å–ª–æ (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—è—Ç—ã–µ)
         */
        function parseNumber(value) {
            if (typeof value === 'number') return value;
            if (!value) return 0;
            
            const strValue = String(value).replace(',', '.');
            const num = parseFloat(strValue);
            return isNaN(num) ? 0 : num;
        }
        /**
         * –ü–∞—Ä—Å–∏—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ–π –∏–Ω—Ç–µ—Ä–≤–∞–ª HH:MM:SS –≤ —Å–µ–∫—É–Ω–¥—ã
         */
        function parseTimeInterval(timeValue) {
            if (!timeValue) return 0;
            
            const str = String(timeValue);
            const parts = str.split(':').map(p => parseInt(p) || 0);
            
            if (parts.length === 3) {
                return parts[0] * 3600 + parts[1] * 60 + parts[2];
            } else if (parts.length === 2) {
                return parts[0] * 60 + parts[1];
            }
            
            return 0;
        }
        /**
         * –§–∏–ª—å—Ç—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –¥–Ω–µ–π
         */
        function filterByDateRange(data, days) {
            const cutoffDate = dayjs().subtract(days, 'day');
            
            return data.filter(row => {
                const date = parseDate(row['–î–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–π']);
                return date && date.isAfter(cutoffDate);
            });
        }
        /**
         * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ (ETL –ø—Ä–æ—Ü–µ—Å—Å)
         */
        function processData(rawData) {
            // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ
            const filteredData = filterByDateRange(rawData, CONFIG.DATE_RANGE_DAYS);
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ–∫—É
            const processedData = filteredData.map(row => {
                return {
                    resource: row['–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–µ—Å—É—Ä—Å'] || '',
                    date: parseDate(row['–î–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–π']),
                    operation: (row['–ù–∞–∑–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏'] || '').toLowerCase().trim(),
                    operationCount: parseNumber(row['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø–µ—Ä–∞—Ü–∏–π']),
                    avgTime: parseNumber(row['–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏']),
                    totalTime: parseNumber(row['–û–±—â–µ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π']),
                    workDuration: parseTimeInterval(row['–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã']),
                    qtyPieces: parseNumber(row['–ö–æ–ª-–≤–æ, —à—Ç']),
                    qtyPackages: parseNumber(row['–ö–æ–ª-–≤–æ, —É–ø']),
                    qtyLines: parseNumber(row['–ö–æ–ª-–≤–æ, —Å—Ç—Ä–æ–∫']),
                    weight: parseNumber(row['–í–µ—Å']),
                    volume: parseNumber(row['–û–±—ä–µ–º'])
                };
            });
            
            return processedData;
        }
        /**
         * –ì—Ä—É–ø–ø–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –º–µ—Ç—Ä–∏–∫–∏
         */
        function groupByEmployee(data, operationFilter, metricField) {
            // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –æ–ø–µ—Ä–∞—Ü–∏—è–º
            const filtered = data.filter(row => {
                if (Array.isArray(operationFilter)) {
                    return operationFilter.some(op => row.operation.includes(op));
                } else {
                    return row.operation.includes(operationFilter);
                }
            });
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º
            const grouped = _.groupBy(filtered, 'resource');
            
            // –í—ã—á–∏—Å–ª—è–µ–º —Å—É–º–º—ã
            const result = Object.entries(grouped).map(([employee, rows]) => {
                const total = _.sumBy(rows, metricField);
                return {
                    employee,
                    value: total
                };
            });
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é
            return _.orderBy(result, ['value'], ['desc']);
        }
        /**
         * –ò–∑–≤–ª–µ–∫–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
         */
        function extractMetrics(processedData) {
            // –ü—Ä–∏—ë–º–∫–∞: –æ–ø–µ—Ä–∞—Ü–∏—è "–ø—Ä–∏–µ–º–∫–∞", –º–µ—Ç—Ä–∏–∫–∞ "qtyPieces"
            const receiving = groupByEmployee(processedData, '–ø—Ä–∏–µ–º–∫–∞', 'qtyPieces');
            
            // –†–∞–∑–º–µ—â–µ–Ω–∏–µ: –æ–ø–µ—Ä–∞—Ü–∏–∏ "—Ä—É—á–Ω—ã–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è" –∏ "–ø—Ä–∏–≤—è–∑–∫–∞ –∫ –º–µ—Å—Ç–∞–º", –º–µ—Ç—Ä–∏–∫–∞ "qtyPackages"
            const placement = groupByEmployee(
                processedData, 
                ['—Ä—É—á–Ω—ã–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è', '–ø—Ä–∏–≤—è–∑–∫–∞ –∫ –º–µ—Å—Ç–∞–º'], 
                'qtyPackages'
            );
            
            // –°–±–æ—Ä–∫–∞: –æ–ø–µ—Ä–∞—Ü–∏—è "–ø–∏–∫–∏–Ω–≥ –ó–• –ú–ï–ó–û–ù–ò–ù RMIXED", –º–µ—Ç—Ä–∏–∫–∞ "operationCount"
            const picking = groupByEmployee(
                processedData, 
                '–ø–∏–∫–∏–Ω–≥ –∑—Ö –º–µ–∑–æ–Ω–∏–Ω rmixed', 
                'operationCount'
            );
            
            return { receiving, placement, picking };
        }
        // ============================================
        // –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø
        // ============================================
        
        /**
         * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ü–≤–µ—Ç —Å—Ç–æ–ª–±—Ü–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –Ω–æ—Ä–º—ã
         */
        function getBarColor(value, norm) {
            const percentage = (value / norm) * 100;
            
            if (percentage < 70) {
                return CONFIG.COLORS.LOW;    // –ö—Ä–∞—Å–Ω—ã–π: 0-70%
            } else if (percentage < 100) {
                return CONFIG.COLORS.MID;    // –ñ–µ–ª—Ç—ã–π: 70-100%
            } else {
                return CONFIG.COLORS.HIGH;   // –ó–µ–ª–µ–Ω—ã–π: 100%+
            }
        }
        /**
         * –í—ã—á–∏—Å–ª—è–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —à–∞–≥ –¥–ª—è —à–∫–∞–ª—ã
         */
        function calculateStepSize(maxValue, norm) {
            const reference = Math.max(maxValue, norm * 2);
            const magnitude = Math.pow(10, Math.floor(Math.log10(reference)));
            const normalized = reference / magnitude;
            
            let stepSize;
            if (normalized <= 1) stepSize = magnitude / 10;
            else if (normalized <= 2) stepSize = magnitude / 5;
            else if (normalized <= 5) stepSize = magnitude / 2;
            else stepSize = magnitude;
            
            return Math.ceil(stepSize);
        }
        /**
         * –°–æ–∑–¥–∞—ë—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –≥—Ä–∞—Ñ–∏–∫
         */
        function createOrUpdateChart(canvasId, chartKey, data, title, norm) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            const labels = data.map(d => d.employee);
            const values = data.map(d => d.value);
            const colors = values.map(v => getBarColor(v, norm));
            
            // –í—ã—á–∏—Å–ª—è–µ–º –æ–±—â—É—é —Å—É–º–º—É –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            const total = _.sum(values);
            const maxValue = Math.max(...values, norm * 1.2);
            const stepSize = calculateStepSize(maxValue, norm);
            
            // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –æ–±—â–µ–π —Å—É–º–º–æ–π
            const chartTitle = `${title} ‚Äî –í—Å–µ–≥–æ: ${total.toLocaleString('ru-RU')} (–Ω–æ—Ä–º–∞: ${norm})`;
            
            // –ï—Å–ª–∏ –≥—Ä–∞—Ñ–∏–∫ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ
            if (charts[chartKey]) {
                charts[chartKey].data.labels = labels;
                charts[chartKey].data.datasets[0].data = values;
                charts[chartKey].data.datasets[0].backgroundColor = colors;
                charts[chartKey].data.datasets[1].data = new Array(labels.length).fill(norm);
                charts[chartKey].options.plugins.title.text = chartTitle;
                charts[chartKey].options.scales.y.ticks.stepSize = stepSize;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∞–Ω–Ω–æ—Ç–∞—Ü–∏—é –Ω–æ—Ä–º—ã
                if (charts[chartKey].options.plugins.annotation) {
                    charts[chartKey].options.plugins.annotation.annotations.normLine.yMin = norm;
                    charts[chartKey].options.plugins.annotation.annotations.normLine.yMax = norm;
                }
                
                charts[chartKey].update('none');
                return;
            }
            
            // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –≥—Ä–∞—Ñ–∏–∫
            charts[chartKey] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: title,
                            data: values,
                            backgroundColor: colors,
                            borderColor: colors,
                            borderWidth: 1.5,
                            borderRadius: 6,
                            order: 2
                        },
                        {
                            label: `–ù–æ—Ä–º–∞: ${norm}`,
                            data: new Array(labels.length).fill(norm),
                            type: 'line',
                            borderColor: '#e74c3c',
                            borderWidth: 2.5,
                            borderDash: [8, 4],
                            fill: false,
                            pointRadius: 0,
                            pointHoverRadius: 0,
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: chartTitle,
                            font: {
                                size: 14,
                                weight: 'bold'
                            },
                            padding: {
                                top: 5,
                                bottom: 10
                            }
                        },
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleFont: {
                                size: 13,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 12
                            },
                            padding: 10,
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    const percentage = ((value / norm) * 100).toFixed(0);
                                    return `${value} (${percentage}% –æ—Ç –Ω–æ—Ä–º—ã)`;
                                }
                            }
                        },
                        annotation: {
                            annotations: {
                                normLine: {
                                    type: 'line',
                                    yMin: norm,
                                    yMax: norm,
                                    borderColor: '#e74c3c',
                                    borderWidth: 2.5,
                                    borderDash: [8, 4],
                                    label: {
                                        display: true,
                                        content: `–ù–æ—Ä–º–∞: ${norm}`,
                                        position: 'start',
                                        backgroundColor: '#e74c3c',
                                        color: '#fff',
                                        font: {
                                            size: 11,
                                            weight: 'bold'
                                        },
                                        padding: 4,
                                        yAdjust: -10
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: stepSize,
                                precision: 0,
                                font: {
                                    size: 11,
                                    weight: '500'
                                },
                                color: '#333'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.08)',
                                lineWidth: 1
                            },
                            border: {
                                display: true,
                                color: '#999'
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 10,
                                    weight: '500'
                                },
                                color: '#333',
                                maxRotation: 45,
                                minRotation: 30
                            },
                            grid: {
                                display: false
                            },
                            border: {
                                display: true,
                                color: '#999'
                            }
                        }
                    }
                }
            });
        }
        /**
         * –û–±–Ω–æ–≤–ª—è–µ—Ç KPI –∫–∞—Ä—Ç–æ—á–∫–∏
         */
        function updateKPIs(metrics) {
            const receivingTotal = _.sumBy(metrics.receiving, 'value');
            const placementTotal = _.sumBy(metrics.placement, 'value');
            const pickingTotal = _.sumBy(metrics.picking, 'value');
            
            document.getElementById('kpiReceiving').textContent = receivingTotal.toLocaleString('ru-RU');
            document.getElementById('kpiPlacement').textContent = placementTotal.toLocaleString('ru-RU');
            document.getElementById('kpiPicking').textContent = pickingTotal.toLocaleString('ru-RU');
        }
        /**
         * –û–±–Ω–æ–≤–ª—è–µ—Ç –¢–û–ü-3 —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
         */
        function updateTopPerformers(metrics) {
            // –¢–û–ü-3 –ø–æ –ø—Ä–∏—ë–º–∫–µ
            const topReceiving = metrics.receiving.slice(0, CONFIG.TOP_N);
            const receivingHTML = `
                <h4>üèÜ –¢–û–ü-3 –ø–æ –ø—Ä–∏—ë–º–∫–µ</h4>
                <ol>
                    ${topReceiving.map(item => 
                        `<li>${item.employee} ‚Äî <strong>${item.value.toLocaleString('ru-RU')}</strong> —à—Ç</li>`
                    ).join('')}
                </ol>
            `;
            document.getElementById('topReceiving').innerHTML = receivingHTML;
            
            // –¢–û–ü-3 –ø–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—é
            const topPlacement = metrics.placement.slice(0, CONFIG.TOP_N);
            const placementHTML = `
                <h4>üèÜ –¢–û–ü-3 –ø–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—é</h4>
                <ol>
                    ${topPlacement.map(item => 
                        `<li>${item.employee} ‚Äî <strong>${item.value.toLocaleString('ru-RU')}</strong> –∫–æ—Ä–æ–±–æ–≤</li>`
                    ).join('')}
                </ol>
            `;
            document.getElementById('topPlacement').innerHTML = placementHTML;
            
            // –¢–û–ü-3 –ø–æ —Å–±–æ—Ä–∫–µ
            const topPicking = metrics.picking.slice(0, CONFIG.TOP_N);
            const pickingHTML = `
                <h4>üèÜ –¢–û–ü-3 –ø–æ —Å–±–æ—Ä–∫–µ</h4>
                <ol>
                    ${topPicking.map(item => 
                        `<li>${item.employee} ‚Äî <strong>${item.value.toLocaleString('ru-RU')}</strong> –∑–∞–¥–∞—á</li>`
                    ).join('')}
                </ol>
            `;
            document.getElementById('topPicking').innerHTML = pickingHTML;
        }
        /**
         * –û–±–Ω–æ–≤–ª—è–µ—Ç –±–ª–æ–∫ —Å –Ω–æ—Ä–º–∞—Ç–∏–≤–∞–º–∏
         */
        function updateNormsDisplay() {
            document.getElementById('normReceiving').textContent = CONFIG.NORMS.receiving.toLocaleString('ru-RU');
            document.getElementById('normPlacement').textContent = CONFIG.NORMS.placement.toLocaleString('ru-RU');
            document.getElementById('normPicking').textContent = CONFIG.NORMS.picking.toLocaleString('ru-RU');
        }
        /**
         * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É
         */
        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = `<div class="error">‚ö†Ô∏è ${message}</div>`;
        }
        /**
         * –°–∫—Ä—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É
         */
        function hideError() {
            document.getElementById('errorContainer').innerHTML = '';
        }
        /**
         * –û–±–Ω–æ–≤–ª—è–µ—Ç –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
         */
        function updateLastUpdateTime() {
            const now = dayjs().format('HH:mm:ss');
            document.getElementById('lastUpdate').textContent = `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${now}`;
        }
        // ============================================
        // –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê
        // ============================================
        
        /**
         * –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞—à–±–æ—Ä–¥–∞
         */
        async function updateDashboard() {
            try {
                hideError();
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                const rawData = await loadExcelFile(CONFIG.DATA_PATH);
                
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ (ETL)
                const processedData = processData(rawData);
                
                // –ò–∑–≤–ª–µ–∫–∞–µ–º –º–µ—Ç—Ä–∏–∫–∏
                const metrics = extractMetrics(processedData);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º KPI
                updateKPIs(metrics);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
                createOrUpdateChart(
                    'chartReceiving', 
                    'receiving', 
                    metrics.receiving, 
                    '–ü—Ä–∏—ë–º–∫–∞ (—à—Ç)', 
                    CONFIG.NORMS.receiving
                );
                
                createOrUpdateChart(
                    'chartPlacement', 
                    'placement', 
                    metrics.placement, 
                    '–†–∞–∑–º–µ—â–µ–Ω–∏–µ (–∫–æ—Ä–æ–±–∞)', 
                    CONFIG.NORMS.placement
                );
                
                createOrUpdateChart(
                    'chartPicking', 
                    'picking', 
                    metrics.picking, 
                    '–°–±–æ—Ä–∫–∞ (–∑–∞–¥–∞—á–∏)', 
                    CONFIG.NORMS.picking
                );
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¢–û–ü-3
                updateTopPerformers(metrics);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è
                updateLastUpdateTime();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞—à–±–æ—Ä–¥–∞:', error);
                showError(`–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞—à–±–æ—Ä–¥: ${error.message}`);
            }
        }
        /**
         * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
         */
        async function init() {
            console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞—à–±–æ—Ä–¥–∞...');
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –Ω–æ—Ä–º–∞—Ç–∏–≤—ã
            updateNormsDisplay();
            
            // –ü–µ—Ä–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
            await updateDashboard();
            
            // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥ (–æ—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–π–º–µ—Ä)
            setInterval(updateDashboard, CONFIG.REFRESH_INTERVAL_MS);
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ñ–∞–π–ª–∞ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
            // –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞
            setInterval(checkFileChanges, 5000);
            
            console.log('‚úÖ –î–∞—à–±–æ—Ä–¥ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ');
            console.log('üì° –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫');
            console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ñ–∞–π–ª–∞: –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫');
        }
        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>